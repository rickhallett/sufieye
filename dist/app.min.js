document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("graph-container"),t=document.getElementById("searchInput"),n=document.getElementById("categoryFilter"),o=document.getElementById("exportJsonButton"),i=document.querySelector(".graph-loader"),a=(document.querySelector(".mobile-controls"),document.getElementById("graphNavBtn"),document.getElementById("viewInfoBtn"),document.getElementById("viewCatalogBtn"),document.getElementById("searchBtn"),document.querySelector(".network-controls-overlay"),document.getElementById("zoomInBtn"),document.getElementById("zoomOutBtn"),document.getElementById("fitBtn"),document.getElementById("fixedZoomInBtn"),document.getElementById("fixedZoomOutBtn"),document.getElementById("fixedFitBtn"),document.getElementById("node-id-display")),r=document.getElementById("node-name-display"),d=document.getElementById("node-category-display"),c=document.getElementById("node-description-display"),s=document.getElementById("node-connections-list"),l=document.getElementById("node-segments-list"),m=document.getElementById("info-section"),u=document.getElementById("tables-section"),g=document.getElementById("graph-section"),f=document.querySelector("#concepts-table tbody"),y=document.querySelector("#practices-table tbody"),p=document.querySelector("#analogies-table tbody"),h=document.querySelector("#segments-table tbody");let b=[],E=[],v=null,B=new vis.DataSet,I=new vis.DataSet,C=window.innerWidth<=768,w=!1,x=!1,L=null,k=null;function z(e,t){let n=!1;return function(){n||(e.apply(this,arguments),n=!0,setTimeout((function(){n=!1}),t))}}const _={concept:{background:"#18103B",border:"#291960",highlight:{background:"#291960",border:"#3a277e"},hover:{background:"#291960",border:"#3a277e"}},practice:{background:"#103B26",border:"#1a5c3b",highlight:{background:"#1a5c3b",border:"#256d4b"},hover:{background:"#1a5c3b",border:"#256d4b"}},analogy:{background:"#966720",border:"#b7832e",highlight:{background:"#b7832e",border:"#d69f3c"},hover:{background:"#b7832e",border:"#d69f3c"}},segment:{background:"#3B1016",border:"#5e1a23",highlight:{background:"#5e1a23",border:"#7d2531"},hover:{background:"#5e1a23",border:"#7d2531"}}};function T(e){const t=document.getElementById("info-panel");t.classList.add("animate__animated","animate__fadeIn"),t.addEventListener("animationend",(()=>{t.classList.remove("animate__animated","animate__fadeIn")})),a.textContent=e.id,r.textContent=e.title,d.textContent=e.category.charAt(0).toUpperCase()+e.category.slice(1),d.style.color=_[e.category].border,d.style.fontWeight="bold",c.textContent=e.description,s.innerHTML="";const n=E.filter((t=>t.from===e.id||t.to===e.id));if(n.forEach((t=>{const o=document.createElement("li");let i,a,r;t.from===e.id?(i=t.to,r=`<i class="fas fa-long-arrow-alt-right" style="color: ${_[e.category].border};"></i> ${t.label||"connects to"}`):(i=t.from,r=`<i class="fas fa-long-arrow-alt-left" style="color: ${_[e.category].border};"></i> ${t.label||"connected from"}`);const d=b.find((e=>e.id===i));a=d?d.title:i,o.innerHTML=`${r} <span class="connected-node-name">${a}</span> <small>(${i})</small>`,o.dataset.nodeId=i,o.classList.add("animate__animated","animate__fadeInRight"),o.style.animationDelay=.05*n.indexOf(t)+"s",o.style.cursor="pointer",o.onclick=()=>{const e=b.find((e=>e.id===i));e&&(T(e),v.focus(e.id,{scale:1.2,animation:{duration:800,easingFunction:"easeInOutQuad"}}))},s.appendChild(o)})),l.innerHTML="","concept"===e.category||"practice"===e.category){const t=E.filter((t=>t.from===e.id&&"segment"===b.find((e=>e.id===t.to))?.category||t.to===e.id&&"segment"===b.find((e=>e.id===t.from))?.category));if(t.forEach((e=>{const n="segment"===b.find((t=>t.id===e.from))?.category?e.from:e.to,o=b.find((e=>e.id===n));if(o){const n=document.createElement("li");n.textContent=`${o.title} (${o.id})`,n.classList.add("animate__animated","animate__fadeInRight"),n.style.animationDelay=.05*t.indexOf(e)+"s",n.style.cursor="pointer",n.onclick=()=>{T(o),v.focus(o.id,{scale:1.2,animation:{duration:800,easingFunction:"easeInOutQuad"}})},l.appendChild(n)}})),0===t.length){const e=document.createElement("li");e.innerHTML="<em>No passages directly connected to this wisdom.</em>",e.style.fontStyle="italic",e.style.opacity="0.7",l.appendChild(e)}}else{const e=document.createElement("li");e.innerHTML="<em>Not applicable for this type of wisdom.</em>",e.style.fontStyle="italic",e.style.opacity="0.7",l.appendChild(e)}v.focus(e.id,{scale:1.2,animation:{duration:800,easingFunction:"easeInOutQuad"}})}function N(){if(!v||!b.length)return;const e=t.value.toLowerCase(),o=n.value,i=b.filter((t=>{const n=t.title.toLowerCase().includes(e),i=t.description.toLowerCase().includes(e),a="all"===o||t.category===o;return(n||i)&&a})).map((e=>e.id));B.clear(),B.add(b.filter((e=>i.includes(e.id)))),I.clear(),I.add(E.filter((e=>i.includes(e.from)&&i.includes(e.to)))),v.fit({animation:{duration:600,easingFunction:"easeInOutQuad"}})}fetch("graph-data.json").then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status} - Did you create graph-data.json?`);return e.json()})).then((n=>{b=n.nodes.map((e=>({id:e.id,label:e.name.length>20?e.name.substring(0,18)+"...":e.name,title:e.name,group:e.category,category:e.category,description:e.description||e.summary||"",timestamp_start:e.timestamp_start,timestamp_end:e.timestamp_end,font:{face:"'Cormorant Garamond', Georgia, serif"}}))),E=n.edges.map((e=>({from:e.source,to:e.target,label:e.label&&e.label.length>15?e.label.substring(0,12)+"...":e.label,arrows:{to:{enabled:!0,scaleFactor:.7,type:"arrow"}},font:{align:"middle",size:11,face:"'Amiri', serif",color:"#e5e1d8",multi:!1,strokeWidth:0},color:{color:"rgba(229, 225, 216, 0.4)",highlight:"#c9a227",hover:"rgba(229, 225, 216, 0.7)"},width:1.5,smooth:{type:"cubicBezier",forceDirection:"horizontal",roundness:.4},length:C?120:180}))),B.add(b),I.add(E),function(){const t={nodes:B,edges:I},n=e.getBoundingClientRect(),o=n.width,i=(n.height,{layout:{improvedLayout:!1,randomSeed:42},edges:{smooth:{type:"cubicBezier",forceDirection:"horizontal",roundness:.4},arrows:{to:{enabled:!0,scaleFactor:.7}},font:{size:11,face:"'Amiri', serif",color:"#e5e1d8",strokeWidth:0,background:"rgba(26, 16, 37, 0.6)",multi:!1},width:1.5,selectionWidth:2.5,hoverWidth:2},nodes:{shape:"ellipse",size:C?30:25,font:{size:C?16:14,face:"'Cormorant Garamond', Georgia, serif",color:"#f5f1e3",strokeWidth:0,strokeColor:"rgba(0,0,0,0.5)"},borderWidth:2,borderWidthSelected:3,shadow:{enabled:!0,color:"rgba(0,0,0,0.3)",size:7,x:3,y:3},scaling:{min:C?20:15,max:C?40:35}},groups:{concept:{color:_.concept,shape:"hexagon",font:{size:C?16:14,color:"#f5f1e3"},size:C?30:25,mass:2.5},practice:{color:_.practice,shape:"diamond",font:{size:C?16:14,color:"#f5f1e3"},size:C?30:25,mass:2},analogy:{color:_.analogy,shape:"star",font:{size:C?16:14,color:"#f5f1e3"},size:C?27:22,mass:1.5},segment:{color:_.segment,shape:"dot",font:{size:C?15:13,color:"#f5f1e3"},size:C?20:15,mass:1}},interaction:{hover:!0,hoverConnectedEdges:!0,tooltipDelay:C?1e3:300,navigationButtons:!1,keyboard:!C,multiselect:!C,selectable:!0,zoomView:!0,dragView:!0,hideEdgesOnDrag:C,hideEdgesOnZoom:C,dragNodes:!C||o>400},physics:{enabled:!0,solver:"forceAtlas2Based",stabilization:{enabled:!0,iterations:800,updateInterval:25,fit:!0},forceAtlas2Based:{gravitationalConstant:-35,centralGravity:.025,springLength:C?120:150,springConstant:.08,damping:.85,avoidOverlap:.5},minVelocity:.75,maxVelocity:50,timestep:.5,adaptiveTimestep:!0},configure:{enabled:!1}});v&&"function"==typeof v.destroy&&v.destroy();v=new vis.Network(e,t,i),function(){if(!v)return;let t=document.getElementById("fixedZoomInBtn"),n=document.getElementById("fixedZoomOutBtn"),o=document.getElementById("fixedFitBtn");o||(o=document.createElement("button"),o.id="fixedFitBtn",o.className="fixed-zoom-btn fixed-zoom-top-right",o.title="Fit Graph",o.innerHTML='<i class="fas fa-expand"></i>',e.appendChild(o));n||(n=document.createElement("button"),n.id="fixedZoomOutBtn",n.className="fixed-zoom-btn fixed-zoom-bottom-left",n.title="Zoom Out",n.innerHTML='<i class="fas fa-minus"></i>',e.appendChild(n));t||(t=document.createElement("button"),t.id="fixedZoomInBtn",t.className="fixed-zoom-btn fixed-zoom-bottom-right",t.title="Zoom In",t.innerHTML='<i class="fas fa-plus"></i>',e.appendChild(t));if(t=document.getElementById("fixedZoomInBtn"),t){const e=t.cloneNode(!0);t.parentNode&&t.parentNode.replaceChild(e,t),e.addEventListener("click",(function(e){e.stopPropagation();try{const e=1.2*v.getScale();v.moveTo({scale:e,animation:{duration:300,easingFunction:"easeOutQuad"}})}catch(e){console.error("Error in fixed zoom in:",e)}}))}if(n=document.getElementById("fixedZoomOutBtn"),n){const e=n.cloneNode(!0);n.parentNode&&n.parentNode.replaceChild(e,n),e.addEventListener("click",(function(e){e.stopPropagation();try{const e=.8*v.getScale();v.moveTo({scale:e,animation:{duration:300,easingFunction:"easeOutQuad"}})}catch(e){console.error("Error in fixed zoom out:",e)}}))}if(o=document.getElementById("fixedFitBtn"),o){const e=o.cloneNode(!0);o.parentNode&&o.parentNode.replaceChild(e,o),e.addEventListener("click",(function(e){e.stopPropagation();try{v.fit({animation:{duration:600,easingFunction:"easeOutQuad"}})}catch(e){console.error("Error in fixed fit:",e)}}))}}(),setTimeout((()=>{try{v.fit({animation:{duration:1e3,easingFunction:"easeOutQuint"}})}catch(e){console.error("Error during initial fit:",e)}}),500),function(){if(!v)return;v.off("click"),v.off("hoverNode"),v.off("blurNode"),v.off("dragStart"),v.off("dragEnd"),v.off("zoom"),v.on("dragStart",(function(){x=!0,L&&clearTimeout(L)})),v.on("dragEnd",(function(){L=setTimeout((function(){x=!1}),300)})),v.on("zoom",(function(){x=!0,L&&clearTimeout(L),L=setTimeout((function(){x=!1}),300)})),v.on("click",(function(e){if(a.textContent="-",r.textContent="-",d.textContent="-",d.style.color="",c.textContent="-",s.innerHTML="",l.innerHTML="",e.nodes&&e.nodes.length>0){const t=e.nodes[0],n=b.find((e=>e.id===t));n&&(T(n),C&&m.scrollIntoView({behavior:"smooth"}))}}));const e=z((function(e){if(!x)try{const t=e.node;if(k===t)return;k=t;const n=B.get(t);if(n){const e=n.category||n.group,o=_[e].hover.border;B.update({id:t,shadow:{enabled:!0,color:o,size:15,x:0,y:0}})}}catch(e){console.error("Error in hoverNode:",e)}}),80),t=z((function(e){try{const t=e.node;k===t&&(k=null),B.update({id:t,shadow:{enabled:!0,color:"rgba(0,0,0,0.3)",size:7,x:3,y:3}})}catch(e){console.error("Error in blurNode:",e)}}),80);v.on("hoverNode",e),v.on("blurNode",t);const n=function(){C=window.innerWidth<=768,v&&setTimeout((()=>{try{v.fit({animation:{duration:500,easingFunction:"easeOutCubic"}})}catch(e){console.error("Error during resize fit:",e)}}),250)};window.removeEventListener("resize",n),window.addEventListener("resize",n)}(),C&&function(){if(!document.getElementById("graph-container")||!v)return;const e=document.getElementById("zoomInBtn"),t=document.getElementById("zoomOutBtn"),n=document.getElementById("fitBtn");if(!e||!t||!n)return void console.warn("Mobile control buttons not found. Mobile controls will be limited.");const o=e.cloneNode(!0),i=t.cloneNode(!0),a=n.cloneNode(!0);e.parentNode.replaceChild(o,e),t.parentNode.replaceChild(i,t),n.parentNode.replaceChild(a,n),o.addEventListener("click",(function(){try{const e=1.2*v.getScale();v.moveTo({scale:e,animation:{duration:300,easingFunction:"easeOutQuad"}})}catch(e){console.error("Error in zoom in:",e)}})),i.addEventListener("click",(function(){try{const e=.8*v.getScale();v.moveTo({scale:e,animation:{duration:300,easingFunction:"easeOutQuad"}})}catch(e){console.error("Error in zoom out:",e)}})),a.addEventListener("click",(function(){try{v.fit({animation:{duration:800,easingFunction:"easeOutQuad"}})}catch(e){console.error("Error in fit:",e)}}));const r=document.querySelector(".network-controls-overlay");r&&(r.style.display="flex")}();v.on("stabilizationIterationsDone",(function(){setTimeout((()=>{try{v.fit({animation:{duration:800,easingFunction:"easeOutQuint"}}),v.setOptions({physics:{enabled:!1,stabilization:{enabled:!1},minVelocity:5,maxVelocity:20}}),w=!0}catch(e){console.error("Error during stabilization:",e)}}),500)}))}(),function(){const t={concept:f,practice:y,analogy:p,segment:h},n={concept:document.getElementById("concepts-cards"),practice:document.getElementById("practices-cards"),analogy:document.getElementById("analogies-cards"),segment:document.getElementById("segments-cards")};for(const e in t)t[e]&&(t[e].innerHTML=""),n[e]&&(n[e].innerHTML="");if(b.forEach((o=>{const i=t[o.category],a=n[o.category];if(i){const t=i.insertRow();if(t.insertCell().textContent=o.id,t.insertCell().textContent=o.title,"segment"===o.category?t.insertCell().textContent=o.summary||o.description:t.insertCell().textContent=o.description,"segment"===o.category&&3===h.rows[0].cells.length&&(h.rows[0].insertCell().textContent="Timestamp Start",h.rows[0].insertCell().textContent="Timestamp End"),"segment"===o.category){t.insertCell().textContent=o.timestamp_start||"-";t.insertCell().textContent=o.timestamp_end||"-"}if(t.style.cursor="pointer",t.style.transition="all 0.3s ease",t.classList.add("table-row-"+o.category),t.addEventListener("mouseenter",(()=>{t.style.backgroundColor="rgba(255, 255, 255, 0.1)",t.style.borderLeft=`3px solid ${_[o.category].border}`})),t.addEventListener("mouseleave",(()=>{t.style.backgroundColor="",t.style.borderLeft=""})),t.onclick=()=>{T(o),v&&B.get(o.id)?(v.focus(o.id,{scale:1.5,animation:{duration:800,easingFunction:"easeInOutQuad"}}),C&&setTimeout((()=>{e.scrollIntoView({behavior:"smooth"})}),300)):alert("This node isn't currently visible in the graph based on your filters. Please adjust your filters to view it in the network.")},a){const t=document.createElement("div");t.className="data-card",t.dataset.nodeId=o.id,t.style.borderLeftColor=_[o.category].border;const n=document.createElement("div");n.className="data-card-header";const i=document.createElement("span");i.className="data-card-id",i.textContent=o.id;const r=document.createElement("div");r.className="data-card-title",r.textContent=o.title;const d=document.createElement("div");if(d.className="data-card-description",d.textContent="segment"===o.category&&o.summary||o.description,n.appendChild(r),n.appendChild(i),t.appendChild(n),t.appendChild(d),"segment"===o.category&&(o.timestamp_start||o.timestamp_end)){const e=document.createElement("div");e.className="data-card-meta",e.textContent=`Time: ${o.timestamp_start||"-"} to ${o.timestamp_end||"-"}`,t.appendChild(e)}a.appendChild(t),t.onclick=()=>{T(o),v&&B.get(o.id)?(v.focus(o.id,{scale:1.5,animation:{duration:800,easingFunction:"easeInOutQuad"}}),C&&setTimeout((()=>{e.scrollIntoView({behavior:"smooth"})}),300)):alert("This node isn't currently visible in the graph based on your filters. Please adjust your filters to view it in the network.")}}}})),h&&h.rows.length>0&&h.rows[0].cells.length>3){const e=h.rows[0];"Summary"!==e.cells[2].textContent&&(e.cells[2].textContent="Summary")}}(),function(){if(!C)return;const e=document.getElementById("zoomInBtn"),n=document.getElementById("zoomOutBtn"),o=document.getElementById("fitBtn"),i=document.getElementById("graphNavBtn"),a=document.getElementById("viewInfoBtn"),r=document.getElementById("viewCatalogBtn"),d=document.getElementById("searchBtn"),c=document.querySelector(".network-controls-overlay");if(!v||!c)return void console.warn("Required elements for mobile controls not found");e&&e.addEventListener("click",(function(){const e=1.2*v.getScale();v.moveTo({scale:e,animation:!0})}));n&&n.addEventListener("click",(function(){const e=.8*v.getScale();v.moveTo({scale:e,animation:!0})}));o&&o.addEventListener("click",(function(){v.fit({animation:{duration:800,easingFunction:"easeInOutQuad"}})}));i&&c&&g&&i.addEventListener("click",(function(){c.style.display="flex"===c.style.display?"none":"flex",g.scrollIntoView({behavior:"smooth",block:"start"})}));a&&m&&a.addEventListener("click",(function(){m.scrollIntoView({behavior:"smooth",block:"start"})}));r&&u&&r.addEventListener("click",(function(){u.scrollIntoView({behavior:"smooth",block:"start"})}));d&&t&&d.addEventListener("click",(function(){t.focus();const e=document.querySelector(".controls");e&&e.scrollIntoView({behavior:"smooth",block:"start"})}));window.addEventListener("orientationchange",(function(){setTimeout((()=>{v&&v.fit({animation:!0})}),300)})),c&&i&&document.addEventListener("click",(function(e){"flex"!==c.style.display||c.contains(e.target)||e.target===i||(c.style.display="none")}))}(),setTimeout((()=>{i.classList.add("animate__animated","animate__fadeOut"),i.addEventListener("animationend",(()=>{i.style.display="none"}))}),1200)})).catch((t=>{console.error("Error loading graph data:",t),e.innerHTML=`<p style="color:#c9a227; text-align:center; font-family:'Amiri',serif; font-style:italic;">Error loading graph data. Make sure 'graph-data.json' exists and is valid. Details: ${t.message}</p>`,i.style.display="none"})),t.addEventListener("input",N),n.addEventListener("change",N),o.addEventListener("click",(function(){o.classList.add("animate__animated","animate__pulse");const e={nodes:b.map((e=>{const t={id:e.id,name:e.title,category:e.category};return"segment"===e.category?(t.summary=e.description,e.timestamp_start&&(t.timestamp_start=e.timestamp_start),e.timestamp_end&&(t.timestamp_end=e.timestamp_end)):t.description=e.description,t})),edges:E.map((e=>({source:e.from,target:e.to,label:e.label})))},t="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e,null,2)),n=document.createElement("a");n.setAttribute("href",t),n.setAttribute("download","sufi_wisdom_export.json"),document.body.appendChild(n),n.click(),n.remove(),setTimeout((()=>{o.classList.remove("animate__animated","animate__pulse")}),1e3)})),window.addEventListener("resize",(function(){C=window.innerWidth<=768,v&&v.setOptions({nodes:{size:C?30:25,font:{size:C?16:14}}})}))}));